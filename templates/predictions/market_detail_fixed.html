{% extends 'base.html' %}

{% block title %}{{ market.title }} - Voy a Mi{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="mb-2" style="font-size: 0.85rem; color: var(--text-tertiary);">
    <a href="{% url 'predictions:index' %}">Markets</a> /
    <a href="{% url 'predictions:event_detail' event.slug %}">{{ event.title|truncatewords:3 }}</a>
</div>

<!-- Main Hero -->
<div class="detail-hero">
    {% if market.display_image %}
    <img src="{{ market.display_image.url }}" class="hero-thumb" alt="Market">
    {% endif %}
    <h1 class="detail-title">{{ market.title }}</h1>
    <div class="market-meta" style="justify-content: center;">
        {% if market.is_trading_active %}
        <span class="text-green">● Trading Active</span>
        {% else %}
        <span>● {{ market.get_status_display }}</span>
        {% endif %}
        <span>• Vol: ${{ market.total_volume }}</span>
    </div>

    <!-- Prices -->
    <div class="detail-price-row">
        <div class="price-block">
            <span class="price-label">YES</span>
            <div class="price-value text-yes" id="yes-price">{{ ob_prices.yes_price }}c</div>
            <div style="font-size: 0.8rem; color: var(--text-tertiary);"><span id="yes-implied">{{ ob_prices.yes_price }}</span>%</div>
        </div>
        <div class="price-block">
            <span class="price-label">NO</span>
            <div class="price-value text-no" id="no-price">{{ ob_prices.no_price }}c</div>
            <div style="font-size: 0.8rem; color: var(--text-tertiary);"><span id="no-implied">{{ ob_prices.no_price }}</span>%</div>
        </div>
    </div>
</div>

<!-- Chart -->
<div class="chart-container">
    <div class="d-flex justify-between items-center mb-2" style="padding: 0 8px;">
        <span style="font-size: 0.85rem; font-weight: 600;">Price History</span>
        <div style="display: flex; gap: 4px;">
            <button class="btn-outline active" style="padding: 2px 8px; font-size: 0.75rem;" data-timeframe="24h">24H</button>
            <button class="btn-outline" style="padding: 2px 8px; font-size: 0.75rem;" data-timeframe="all">All</button>
        </div>
    </div>
    <div style="height: 200px; position: relative;">
        <canvas id="priceChart"></canvas>
        <div id="chartLoading"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-tertiary);">
            Loading...
        </div>
    </div>
</div>

<!-- Trading Interface -->
{% if market.is_trading_active %}
<div class="trading-card">
    <div class="tab-nav">
        <button class="tab-btn active" id="quick-bet-tab" onclick="switchTab('quick')">Quick Bet</button>
        <button class="tab-btn" id="limit-order-tab" onclick="switchTab('limit')">Limit Order</button>
    </div>

    <div class="trade-form">
        {% if user.is_authenticated %}
        <!-- Quick Bet Form -->
        <div id="quick-bet-panel">
            <form method="post" action="{% url 'predictions:place_quick_bet' market.pk %}" id="quick-bet-form">
                {% csrf_token %}
                <input type="hidden" name="price" value=""> <!-- Blank for market order -->

                <!-- Buy/Sell Toggle (Hidden radio, custom UI) -->
                <div class="outcome-selector">
                    <label class="outcome-option selected" id="opt-buy" onclick="setSide('BUY')">Buy</label>
                    <label class="outcome-option" id="opt-sell" onclick="setSide('SELL')">Sell</label>
                </div>
                <!-- Hidden inputs for form -->
                <input type="radio" name="action" id="quick_buy" value="buy" checked class="d-none">
                <input type="radio" name="action" id="quick_sell" value="sell" class="d-none">

                <!-- Outcome Toggle -->
                <div class="outcome-selector">
                    <label class="outcome-option selected yes" id="opt-yes" onclick="setOutcome('YES')">YES</label>
                    <label class="outcome-option no" id="opt-no" onclick="setOutcome('NO')">NO</label>
                </div>
                <input type="radio" name="contract_type" id="quick_type_yes" value="yes" checked class="d-none">
                <input type="radio" name="contract_type" id="quick_type_no" value="no" class="d-none">

                <!-- Amount Input -->
                <div class="amount-input-group">
                    <span class="amount-label" id="amount-prefix">$</span>
                    <input type="number" class="amount-input" name="amount" id="quick_amount" value="5" step="any">
                    <!-- Renamed ID to match JS -->
                    <span class="amount-label d-none" id="shares-suffix">Shares</span>
                </div>

                <!-- Summary -->
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Avg Price</span>
                        <span id="estimate-price">-</span>
                    </div>
                    <div class="summary-row">
                        <span id="estimate-shares-label">Est. Shares</span>
                        <span id="estimate-shares">-</span>
                    </div>
                    <div class="summary-row">
                        <span id="estimate-result-label">Potential Payout</span>
                        <span id="estimate-payout">-</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100" id="quick-bet-button"
                    style="font-size: 1.1rem; padding: 14px;">
                    Place Order
                </button>
            </form>
        </div>

        <!-- Limit Order Form -->
        <div id="limit-order-panel" class="d-none">
            <form method="post" action="{% url 'predictions:place_order' market.pk %}">
                {% csrf_token %}

                <!-- Buy/Sell Toggle -->
                <div class="outcome-selector">
                    <label class="outcome-option selected" id="limit-opt-buy" onclick="setLimitSide('BUY')">Buy</label>
                    <label class="outcome-option" id="limit-opt-sell" onclick="setLimitSide('SELL')">Sell</label>
                </div>
                <input type="radio" name="order_type" id="limit_buy" value="BUY" checked class="d-none">
                <input type="radio" name="order_type" id="limit_sell" value="SELL" class="d-none">

                <!-- Outcome Toggle (YES/NO) -->
                <div class="outcome-selector">
                    <label class="outcome-option selected yes" id="limit-opt-yes" onclick="setLimitOutcome('YES')">YES</label>
                    <label class="outcome-option no" id="limit-opt-no" onclick="setLimitOutcome('NO')">NO</label>
                </div>
                <input type="radio" name="outcome" id="limit_yes" value="YES" checked class="d-none">
                <input type="radio" name="outcome" id="limit_no" value="NO" class="d-none">

                <div class="amount-input-group">
                    <span class="amount-label">Price</span>
                    <input type="number" class="amount-input" name="price" id="limit_price_input" value="50" step="1" min="1" max="99">
                    <span class="amount-label">cents</span>
                </div>
                <div class="amount-input-group">
                    <span class="amount-label">Qty</span>
                    <input type="number" class="amount-input" name="quantity" id="limit_quantity_input" value="10" min="1">
                    <span class="amount-label">shares</span>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Total Cost/Proceeds</span>
                        <span id="limit-total">$5.00</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-outline w-100" id="limit-order-button">Place Limit Order</button>
            </form>
        </div>

        {% else %}
        <div style="text-align: center; padding: 20px;">
            <a href="{% url 'login' %}" class="btn btn-primary w-100">Login to Trade</a>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Order Confirmation Modal -->
<div id="order-confirm-modal" class="modal-overlay d-none">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Review Order</h3>
            <button type="button" class="modal-close" onclick="closeOrderModal()">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Order Summary -->
            <div class="order-preview">
                <div class="preview-row action-row">
                    <span class="preview-label">Action</span>
                    <span id="preview-action" class="preview-value">Buy YES</span>
                </div>

                <div class="preview-divider"></div>

                <div class="preview-row">
                    <span class="preview-label">Shares</span>
                    <span id="preview-shares" class="preview-value">--</span>
                </div>

                <div class="preview-row">
                    <span class="preview-label">Average Price</span>
                    <span id="preview-avg-price" class="preview-value">--</span>
                </div>

                <div class="preview-row highlight">
                    <span class="preview-label" id="preview-cost-label">Estimated Cost</span>
                    <span id="preview-total-cost" class="preview-value">--</span>
                </div>

                <div class="preview-divider"></div>

                <div class="preview-row potential">
                    <span class="preview-label">Payout if Yes</span>
                    <span id="preview-payout" class="preview-value text-success">--</span>
                </div>

                <div class="preview-row">
                    <span class="preview-label">Potential Profit</span>
                    <span id="preview-profit" class="preview-value text-success">--</span>
                </div>

                <div class="preview-row">
                    <span class="preview-label">Odds</span>
                    <span id="preview-probability" class="preview-value">--</span>
                </div>
            </div>

            <!-- User Balance -->
            <div class="balance-info">
                <span>Your Balance: <strong id="preview-balance">$0.00</strong></span>
            </div>

            <!-- Warning Messages -->
            <div id="preview-warning" class="preview-warning d-none"></div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-outline modal-back-btn" onclick="closeOrderModal()">
                <span style="margin-right: 8px;">&larr;</span> Back
            </button>
            <button type="button" class="btn btn-primary" id="confirm-order-btn" onclick="confirmOrder()">
                Submit
            </button>
        </div>
    </div>
</div>

<!-- Orderbook Section -->
<div class="orderbook-section">
    <div class="section-title">Orderbook</div>
    <div
        style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
        <div class="d-flex">
            <div style="flex: 1; border-right: 1px solid var(--border-color);">
                <div
                    style="padding: 8px; text-align: center; font-weight: 600; color: var(--pm-green); border-bottom: 1px solid var(--border-color);">
                    YES</div>
                <!-- YES Bids/Asks -->
                <table class="orderbook-table">
                    <tbody id="yes-bids-body">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
            <div style="flex: 1;">
                <div
                    style="padding: 8px; text-align: center; font-weight: 600; color: var(--pm-red); border-bottom: 1px solid var(--border-color);">
                    NO</div>
                <table class="orderbook-table">
                    <tbody id="no-bids-body">
                        <!-- JS injected -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Trades Section -->
<div class="orderbook-section mb-4">
    <div class="section-title">Recent Trades</div>
    <div
        style="background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto;">
        <table class="orderbook-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th class="text-end">Qty</th>
                </tr>
            </thead>
            <tbody id="trades-tbody">
                <!-- JS Injected -->
            </tbody>
        </table>
    </div>
</div>

<!-- Extra JS for Tabs (Custom) -->
<script>
    function switchTab(tab) {
        if (tab === 'quick') {
            document.getElementById('quick-bet-tab').classList.add('active');
            document.getElementById('limit-order-tab').classList.remove('active');
            document.getElementById('quick-bet-panel').classList.remove('d-none');
            document.getElementById('limit-order-panel').classList.add('d-none');
        } else {
            document.getElementById('limit-order-tab').classList.add('active');
            document.getElementById('quick-bet-tab').classList.remove('active');
            document.getElementById('limit-order-panel').classList.remove('d-none');
            document.getElementById('quick-bet-panel').classList.add('d-none');
        }
    }

    function setSide(side) {
        // Update Hidden Radios
        if (side === 'BUY') {
            document.getElementById('quick_buy').checked = true;
            document.getElementById('opt-buy').classList.add('selected');
            document.getElementById('opt-sell').classList.remove('selected');
        } else {
            document.getElementById('quick_sell').checked = true;
            document.getElementById('opt-sell').classList.add('selected');
            document.getElementById('opt-buy').classList.remove('selected');
        }
        // Trigger existing change event for JS logic
        document.getElementById('quick_' + side.toLowerCase()).dispatchEvent(new Event('change'));
    }

    function setOutcome(type) {
        if (type === 'YES') {
            document.getElementById('quick_type_yes').checked = true;
            document.getElementById('opt-yes').classList.add('selected');
            document.getElementById('opt-no').classList.remove('selected');
        } else {
            document.getElementById('quick_type_no').checked = true;
            document.getElementById('opt-no').classList.add('selected');
            document.getElementById('opt-yes').classList.remove('selected');
        }
        document.getElementById('quick_type_' + type.toLowerCase()).dispatchEvent(new Event('change'));
    }

    // Limit Order Form Functions
    function setLimitSide(side) {
        if (side === 'BUY') {
            document.getElementById('limit_buy').checked = true;
            document.getElementById('limit-opt-buy').classList.add('selected');
            document.getElementById('limit-opt-sell').classList.remove('selected');
        } else {
            document.getElementById('limit_sell').checked = true;
            document.getElementById('limit-opt-sell').classList.add('selected');
            document.getElementById('limit-opt-buy').classList.remove('selected');
        }
        updateLimitOrderSummary();
    }

    function setLimitOutcome(outcome) {
        if (outcome === 'YES') {
            document.getElementById('limit_yes').checked = true;
            document.getElementById('limit-opt-yes').classList.add('selected');
            document.getElementById('limit-opt-no').classList.remove('selected');
        } else {
            document.getElementById('limit_no').checked = true;
            document.getElementById('limit-opt-no').classList.add('selected');
            document.getElementById('limit-opt-yes').classList.remove('selected');
        }
        updateLimitOrderSummary();
    }

    function updateLimitOrderSummary() {
        var priceInput = document.getElementById('limit_price_input');
        var qtyInput = document.getElementById('limit_quantity_input');
        var totalDisplay = document.getElementById('limit-total');
        var button = document.getElementById('limit-order-button');
        var isBuy = document.getElementById('limit_buy').checked;
        var isYes = document.getElementById('limit_yes').checked;

        if (priceInput && qtyInput && totalDisplay) {
            var price = parseInt(priceInput.value) || 0;
            var qty = parseInt(qtyInput.value) || 0;
            var total = (price * qty / 100).toFixed(2);
            totalDisplay.textContent = '$' + total;
        }

        if (button) {
            var side = isBuy ? 'Buy' : 'Sell';
            var outcome = isYes ? 'YES' : 'NO';
            button.textContent = side + ' ' + outcome + ' Limit Order';
        }
    }

    // Initialize limit order listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        var limitPrice = document.getElementById('limit_price_input');
        var limitQty = document.getElementById('limit_quantity_input');
        if (limitPrice) limitPrice.addEventListener('input', updateLimitOrderSummary);
        if (limitQty) limitQty.addEventListener('input', updateLimitOrderSummary);
        updateLimitOrderSummary();

        // Initialize order confirmation modal
        interceptOrderForms();
    });

    // ====== ORDER CONFIRMATION MODAL ======
    var pendingOrderData = null;
    var pendingFormElement = null;
    var orderConfirmMarketId = {{ market.pk }};

    function interceptOrderForms() {
        // Quick Bet Form
        var quickBetForm = document.getElementById('quick-bet-form');
        if (quickBetForm) {
            quickBetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showOrderConfirmation(this, 'quick');
            });
        }

        // Limit Order Form
        var limitOrderPanel = document.getElementById('limit-order-panel');
        if (limitOrderPanel) {
            var limitOrderForm = limitOrderPanel.querySelector('form');
            if (limitOrderForm) {
                limitOrderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    showOrderConfirmation(this, 'limit');
                });
            }
        }
    }

    function showOrderConfirmation(formElement, orderSource) {
        pendingFormElement = formElement;

        // Gather order data from form
        var formData = new FormData(formElement);

        var orderData = {
            source: orderSource,
            market_id: orderConfirmMarketId
        };

        if (orderSource === 'quick') {
            orderData.action = formData.get('action') || 'buy';
            orderData.contract_type = formData.get('contract_type') || 'yes';
            orderData.order_type = 'market';
            orderData.amount = parseFloat(formData.get('amount')) || 0;
        } else {
            var orderType = formData.get('order_type');
            orderData.action = orderType === 'BUY' ? 'buy' : 'sell';
            orderData.contract_type = (formData.get('outcome') || 'YES').toLowerCase();
            orderData.order_type = 'limit';
            orderData.price = parseInt(formData.get('price')) || 50;
            orderData.quantity = parseInt(formData.get('quantity')) || 1;
        }

        pendingOrderData = orderData;

        // Fetch order preview from API
        fetchOrderPreview(orderData);
    }

    function fetchOrderPreview(orderData) {
        var url = '/api/markets/' + orderData.market_id + '/order-preview/';

        // Get CSRF token
        var csrfToken = getCsrfToken();

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(orderData)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.error) {
                // Show error in modal
                showPreviewError(data.error);
            } else {
                displayOrderPreview(data, orderData);
            }
        })
        .catch(function(error) {
            console.error('Error fetching preview:', error);
            // Fallback to client-side calculation
            displayOrderPreviewClientSide(orderData);
        });
    }

    function displayOrderPreview(preview, orderData) {
        var modal = document.getElementById('order-confirm-modal');
        var actionText = orderData.action.toUpperCase() + ' ' + orderData.contract_type.toUpperCase();
        var isBuy = orderData.action === 'buy';

        // Update modal content
        var previewAction = document.getElementById('preview-action');
        previewAction.textContent = actionText;
        previewAction.className = 'preview-value ' + (isBuy ? 'text-success' : 'text-danger');

        document.getElementById('preview-shares').textContent = preview.shares + ' shares';
        document.getElementById('preview-avg-price').textContent = preview.avg_price + 'c';

        // Update cost/proceeds label and value
        var costLabel = document.getElementById('preview-cost-label');
        var costValue = document.getElementById('preview-total-cost');
        if (isBuy) {
            costLabel.textContent = 'Estimated Cost';
            costValue.textContent = '$' + preview.total_cost.toFixed(2);
        } else {
            costLabel.textContent = 'You Receive';
            costValue.textContent = '$' + preview.total_proceeds.toFixed(2);
        }

        // Payout label based on contract type
        var payoutLabel = orderData.contract_type === 'yes' ? 'Payout if Yes' : 'Payout if No';
        document.querySelector('.preview-row.potential .preview-label').textContent = payoutLabel;
        document.getElementById('preview-payout').textContent = '$' + preview.potential_payout.toFixed(2);

        // Calculate profit
        var cost = isBuy ? preview.total_cost : 0;
        var profit = preview.potential_payout - cost;
        var profitEl = document.getElementById('preview-profit');
        profitEl.textContent = (profit >= 0 ? '+' : '') + '$' + profit.toFixed(2);
        profitEl.className = 'preview-value ' + (profit >= 0 ? 'text-success' : 'text-danger');

        document.getElementById('preview-probability').textContent = preview.implied_probability + '% chance';
        document.getElementById('preview-balance').textContent = '$' + preview.user_balance.toFixed(2);

        // Check for warnings
        var warningEl = document.getElementById('preview-warning');
        var confirmBtn = document.getElementById('confirm-order-btn');
        if (preview.warning) {
            warningEl.textContent = preview.warning;
            warningEl.classList.remove('d-none');
            confirmBtn.disabled = true;
            confirmBtn.style.opacity = '0.5';
        } else {
            warningEl.classList.add('d-none');
            confirmBtn.disabled = false;
            confirmBtn.style.opacity = '1';
        }

        // Show modal
        modal.classList.remove('d-none');
    }

    function displayOrderPreviewClientSide(orderData) {
        // Fallback calculation when API is unavailable
        var price = 50; // Default price
        var shares, totalCost;

        if (orderData.order_type === 'limit') {
            price = orderData.price;
            shares = orderData.quantity;
            totalCost = shares * price / 100;
        } else {
            // Market order - use a default estimate
            shares = Math.floor(orderData.amount * 100 / price);
            totalCost = orderData.amount;
        }

        var preview = {
            shares: shares,
            avg_price: price,
            total_cost: totalCost,
            total_proceeds: totalCost,
            potential_payout: shares,
            implied_probability: price,
            user_balance: 0,
            warning: null
        };

        displayOrderPreview(preview, orderData);
    }

    function closeOrderModal() {
        var modal = document.getElementById('order-confirm-modal');
        modal.classList.add('d-none');
        pendingOrderData = null;
        pendingFormElement = null;
    }

    function confirmOrder() {
        if (pendingFormElement) {
            // Disable button to prevent double-submit
            var confirmBtn = document.getElementById('confirm-order-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Submitting...';

            // Submit the original form
            pendingFormElement.submit();
        }
    }

    function getCsrfToken() {
        var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return csrfInput ? csrfInput.value : '';
    }

    function showPreviewError(message) {
        var modal = document.getElementById('order-confirm-modal');
        var warningEl = document.getElementById('preview-warning');

        warningEl.textContent = message;
        warningEl.classList.remove('d-none');

        document.getElementById('confirm-order-btn').disabled = true;
        document.getElementById('confirm-order-btn').style.opacity = '0.5';
        modal.classList.remove('d-none');
    }
</script>

{% endblock %}

{% block extra_css %}
<style>
    /* Order Confirmation Modal */
    .modal-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: rgba(0, 0, 0, 0.75) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        z-index: 9999 !important;
        padding: 16px;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.d-none {
        display: none !important;
    }

    .modal-content {
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        max-width: 400px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
    }

    .modal-footer .btn {
        flex: 1;
        padding: 14px 16px;
    }

    .modal-back-btn {
        flex: 0 0 auto !important;
    }

    .order-preview {
        background: var(--bg-main);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .preview-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
    }

    .preview-row.highlight {
        background: rgba(59, 130, 246, 0.15);
        margin: 8px -16px;
        padding: 12px 16px;
        border-radius: 8px;
    }

    .preview-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .preview-value {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .preview-divider {
        height: 1px;
        background: var(--border-color);
        margin: 4px 0;
    }

    .balance-info {
        text-align: center;
        padding: 12px;
        background: var(--bg-main);
        border-radius: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .balance-info strong {
        color: var(--pm-green);
    }

    .preview-warning {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--pm-red);
        border-radius: 8px;
        padding: 12px;
        margin-top: 16px;
        color: var(--pm-red);
        font-size: 0.85rem;
        text-align: center;
    }

    /* Clean up flashing animations */
    .price-up {
        color: var(--pm-green);
        transform: scale(1.1);
        transition: color 0.2s, transform 0.2s;
    }

    .price-down {
        color: var(--pm-red);
        transform: scale(1.1);
        transition: color 0.2s, transform 0.2s;
    }

    #priceChart {
        width: 100% !important;
        height: 100% !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for price history -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
    (function () {
        'use strict';

        // Market ID for WebSocket connection
        const marketId = {{ market.pk }};

    // Order book price data from Django (will be updated by WebSocket)
    const marketPrices = {
        yesPrice: {{ ob_prices.yes_price|default:50 }},
        noPrice: {{ ob_prices.no_price|default:50 }},
        // Keep orderbook data for limit orders
        yesAsk: {{ market.best_yes_ask|default:"null" }},
        noAsk: {{ market.best_no_ask|default:"null" }},
        yesBid: {{ market.best_yes_bid|default:"null" }},
        noBid: {{ market.best_no_bid|default:"null" }}
    };

    // WebSocket connection
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const reconnectDelay = 2000;

    // Create connection status indicator
    function createStatusIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'ws-status';
        indicator.className = 'ws-status connecting';
        indicator.textContent = 'Connecting...';
        indicator.style.display = 'none'; // Hide in this design unless needed
        document.body.appendChild(indicator);
        return indicator;
    }

    // Update status indicator
    function updateStatus(status, text) {
        // console.log(status, text); // simplified handling
    }

    // Connect to WebSocket
    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = wsScheme + '://' + window.location.host + '/ws/market/' + marketId + '/';

        console.log('Connecting to WebSocket:', wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = function (e) {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
        };

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            handleMessage(data);
        };

        socket.onclose = function (e) {
            console.log('WebSocket closed');
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(connectWebSocket, reconnectDelay * reconnectAttempts);
            }
        };

        socket.onerror = function (e) {
            console.error('WebSocket error:', e);
        };
    }

    // Handle incoming WebSocket messages
    function handleMessage(message) {
        const type = message.type;
        const data = message.data || message;  // Handle both nested and flat formats

        switch (type) {
            case 'initial_state':
                updatePrices(data.last_yes_price, data.last_no_price, false);
                marketPrices.yesPrice = data.last_yes_price || 50;
                marketPrices.noPrice = data.last_no_price || 50;
                updateQuickBetEstimate();
                break;

            case 'market_update':
                updatePrices(data.last_yes_price, data.last_no_price, true);
                marketPrices.yesPrice = data.last_yes_price || marketPrices.yesPrice;
                marketPrices.noPrice = data.last_no_price || marketPrices.noPrice;
                updateQuickBetEstimate();
                break;

            case 'trade_executed':
                addTradeToTable(data);
                break;

            case 'orderbook_update':
                // console.log('Orderbook updated:', data);
                break;
        }
    }

    // Update price displays with animation
    function updatePrices(newYesPrice, newNoPrice, animate) {
        const yesPrice = document.getElementById('yes-price');
        const noPrice = document.getElementById('no-price');
        const yesImplied = document.getElementById('yes-implied');
        const noImplied = document.getElementById('no-implied');

        // Update YES price
        if (yesPrice && newYesPrice !== undefined) {
            const oldYes = marketPrices.lastYes || marketPrices.yesPrice;
            if (newYesPrice !== oldYes) {
                yesPrice.textContent = newYesPrice + 'c';
                if (yesImplied) yesImplied.textContent = newYesPrice;
                marketPrices.lastYes = newYesPrice;
                if (animate) {
                    yesPrice.classList.add(newYesPrice > oldYes ? 'price-up' : 'price-down');
                    setTimeout(() => yesPrice.classList.remove('price-up', 'price-down'), 500);
                }
            }
        }

        // Update NO price
        if (noPrice && newNoPrice !== undefined) {
            const oldNo = marketPrices.lastNo || marketPrices.noPrice;
            if (newNoPrice !== oldNo) {
                noPrice.textContent = newNoPrice + 'c';
                if (noImplied) noImplied.textContent = newNoPrice;
                marketPrices.lastNo = newNoPrice;
                if (animate) {
                    noPrice.classList.add(newNoPrice > oldNo ? 'price-up' : 'price-down');
                    setTimeout(() => noPrice.classList.remove('price-up', 'price-down'), 500);
                }
            }
        }
    }

    // Add new trade to the trades table
    function addTradeToTable(trade) {
        const tbody = document.getElementById('trades-tbody');
        if (!tbody) return;

        const row = document.createElement('tr');
        const time = new Date(trade.executed_at);
        const timeStr = time.toLocaleTimeString('en-US', { hour12: false });
        // Simplified Logic for Artifact
        const actionBadgeClass = trade.side === 'buy' ? 'text-green' : 'text-red';
        const typeColor = trade.contract_type === 'yes' ? 'text-green' : 'text-red';

        row.innerHTML = `
            <td>${timeStr}</td>
            <td style="font-weight:600" class="${actionBadgeClass}">${trade.side.toUpperCase()}</td>
            <td>${trade.avg_price}c</td>
            <td class="text-end">${trade.quantity}</td>
        `;

        tbody.insertBefore(row, tbody.firstChild);
        if (tbody.children.length > 20) tbody.removeChild(tbody.lastChild);
    }

    // Send ping to keep connection alive
    function sendPing() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'ping' }));
        }
    }

    // Get market price for a contract type
    function getMarketPrice(contractType) {
        if (contractType === 'yes') {
            return marketPrices.yesPrice || 50;
        } else {
            return marketPrices.noPrice || 50;
        }
    }

    function isSellMode() {
        const sellRadio = document.getElementById('quick_sell');
        return sellRadio && sellRadio.checked;
    }

    function updateBuySellMode() {
        const isSell = isSellMode();
        const amountLabel = document.getElementById('amount-prefix');
        const sharesSuffix = document.getElementById('shares-suffix');
        const amountInput = document.getElementById('quick_amount');
        const estSharesLabel = document.getElementById('estimate-shares-label');
        const resultLabel = document.getElementById('estimate-result-label');

        if (isSell) {
            // Sell mode
            if (amountLabel) amountLabel.classList.add('d-none');
            if (sharesSuffix) sharesSuffix.classList.remove('d-none');
            if (amountInput) { amountInput.step = '1'; amountInput.min = '1'; amountInput.value = '10'; }
            if (estSharesLabel) estSharesLabel.textContent = 'Selling:';
            if (resultLabel) resultLabel.textContent = 'You Receive:';
        } else {
            // Buy mode
            if (amountLabel) amountLabel.classList.remove('d-none');
            if (sharesSuffix) sharesSuffix.classList.add('d-none');
            if (amountInput) { amountInput.step = 'any'; amountInput.min = '0.01'; amountInput.value = '5'; }
            if (estSharesLabel) estSharesLabel.textContent = 'Est. Shares:';
            if (resultLabel) resultLabel.textContent = 'Potential Payout:';
        }
        updateQuickBetEstimate();
    }

    // Update Quick Bet estimates
    function updateQuickBetEstimate() {
        const amountInput = document.getElementById('quick_amount');
        const yesRadio = document.getElementById('quick_type_yes');
        const sharesDisplay = document.getElementById('estimate-shares');
        const priceDisplay = document.getElementById('estimate-price');
        const payoutDisplay = document.getElementById('estimate-payout');
        const betButton = document.getElementById('quick-bet-button');

        if (!amountInput) return;

        const isSell = isSellMode();
        const contractType = yesRadio && yesRadio.checked ? 'yes' : 'no';
        const price = getMarketPrice(contractType);
        const contractLabel = contractType.toUpperCase();

        if (isSell) {
            const shares = parseInt(amountInput.value) || 0;
            const payout = (shares * price / 100).toFixed(2);
            if (sharesDisplay) sharesDisplay.textContent = shares + ' shares';
            if (priceDisplay) priceDisplay.textContent = price + 'c';
            if (payoutDisplay) payoutDisplay.textContent = '$' + payout;
            if (betButton) betButton.textContent = 'Sell ' + shares + ' ' + contractLabel;
        } else {
            const amount = parseFloat(amountInput.value) || 0;
            const shares = Math.floor(amount * 100 / price);
            const payout = shares; // $1 per share
            if (sharesDisplay) sharesDisplay.textContent = shares + ' shares';
            if (priceDisplay) priceDisplay.textContent = price + 'c';
            if (payoutDisplay) payoutDisplay.textContent = '$' + payout.toFixed(2);
            if (betButton) betButton.textContent = 'Buy ' + contractLabel;
        }
    }

    // ====== ORDER BOOK & POSITION POLLING ======
    function fetchOrderBook() {
        fetch('/api/markets/' + marketId + '/orderbook/')
            .then(response => response.json())
            .then(data => {
                if (data.orderbook) {
                    renderOrderBook(data.orderbook);
                }
            })
            .catch(err => console.error('Error fetching orderbook:', err));
    }

    function renderOrderBook(book) {
        renderTableRows('yes-bids-body', book.yes_bids, 'text-yes');
        renderTableRows('no-bids-body', book.no_bids, 'text-no');
    }

    function renderTableRows(elementId, rows, colorClass) {
        const tbody = document.getElementById(elementId);
        if (!tbody) return;

        if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" style="color:var(--text-tertiary); text-align:center;">Empty</td></tr>';
            return;
        }

        let html = '';
        rows.forEach(row => {
            html += `<tr>
                        <td class="${colorClass}">${row.price}c</td>
                        <td class="text-end">${row.quantity}</td>
                     </tr>`;
        });
        tbody.innerHTML = html;
    }

    // ====== RECENT TRADES ======
    function fetchRecentTrades() {
        fetch('/api/markets/' + marketId + '/trades/')
            .then(response => response.json())
            .then(data => {
                if (data.trades) {
                    renderTrades(data.trades);
                }
            })
            .catch(err => console.error('Error fetching trades:', err));
    }

    function renderTrades(trades) {
        const tbody = document.getElementById('trades-tbody');
        if (!tbody) return;

        if (!trades || trades.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text-tertiary); text-align:center; padding: 24px;">No recent trades</td></tr>';
            return;
        }

        let html = '';
        trades.forEach(trade => {
            const time = new Date(trade.executed_at);
            const timeStr = time.toLocaleTimeString('en-US', {hour12: false});
            const sideClass = trade.side === 'buy' ? 'text-green' : 'text-red';

            html += `<tr>
                <td>${timeStr}</td>
                <td style="font-weight:600" class="${sideClass}">${trade.side.toUpperCase()}</td>
                <td>${trade.avg_price}c</td>
                <td class="text-end">${trade.quantity}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // Poll every 2 seconds
    setInterval(fetchOrderBook, 2000);
    setInterval(fetchRecentTrades, 5000);

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        createStatusIndicator();
        connectWebSocket();
        setInterval(sendPing, 30000);

        // Fetch initial data
        fetchOrderBook();
        fetchRecentTrades();

        // Listeners for Quick Bet
        const quickAmount = document.getElementById('quick_amount');
        const quickYes = document.getElementById('quick_type_yes');
        const quickNo = document.getElementById('quick_type_no');
        const quickBuy = document.getElementById('quick_buy');
        const quickSell = document.getElementById('quick_sell');

        if (quickAmount) quickAmount.addEventListener('input', updateQuickBetEstimate);
        if (quickYes) quickYes.addEventListener('change', updateQuickBetEstimate);
        if (quickNo) quickNo.addEventListener('change', updateQuickBetEstimate);
        if (quickBuy) quickBuy.addEventListener('change', updateBuySellMode);
        if (quickSell) quickSell.addEventListener('change', updateBuySellMode);

        updateQuickBetEstimate();

        // Chart
        setTimeout(initPriceChart, 100);

        // Timeframe button handlers
        document.querySelectorAll('[data-timeframe]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var timeframe = this.getAttribute('data-timeframe');
                // Update active state
                document.querySelectorAll('[data-timeframe]').forEach(function(b) {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                // Show loading and fetch new data
                var loader = document.getElementById('chartLoading');
                if (loader) loader.style.display = 'block';
                loadPriceHistory(timeframe);
            });
        });
    });

    window.addEventListener('beforeunload', function () {
        if (socket) socket.close();
    });

    // Chart logic
    let priceChart = null;
    function initPriceChart() {
        const ctx = document.getElementById('priceChart');
        if (!ctx) return;

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'YES',
                    data: [],
                    borderColor: '#00A68C',
                    backgroundColor: 'rgba(0, 166, 140, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }, {
                    label: 'NO',
                    data: [],
                    borderColor: '#E63C3C',
                    backgroundColor: 'rgba(230, 60, 60, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { type: 'time', display: false },
                    y: { display: false }
                }
            }
        });

        loadPriceHistory('24h');
    }

    function loadPriceHistory(timeframe) {
        fetch('/api/markets/' + marketId + '/price-history/?timeframe=' + timeframe)
            .then(function (response) { return response.json(); })
            .then(function (data) {
                var loader = document.getElementById('chartLoading');
                if (loader) loader.style.display = 'none';

                if (data.price_history && data.price_history.length > 0) {
                    var yesData = data.price_history.map(function (p) { return { x: new Date(p.time), y: p.yes_price }; });
                    var noData = data.price_history.map(function (p) { return { x: new Date(p.time), y: p.no_price }; });
                    priceChart.data.datasets[0].data = yesData;
                    priceChart.data.datasets[1].data = noData;
                    priceChart.update();
                }
            })
            .catch(function (err) {
                console.error(err);
                var loader = document.getElementById('chartLoading');
                if (loader) loader.textContent = 'Error';
            });
    }

}) ();
</script>
{% endblock %}