{% extends 'base.html' %}

{% block title %}{{ market.title }} - Voy a Mi{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'predictions:index' %}">Markets</a></li>
        <li class="breadcrumb-item"><a href="{% url 'predictions:event_detail' event.slug %}">{{ event.title|truncatewords:3 }}</a></li>
        <li class="breadcrumb-item active">{{ market.title|truncatewords:5 }}</li>
    </ol>
</nav>

<div class="row">
    <!-- Market Info & Trading -->
    <div class="col-lg-8">
        <!-- Market Header -->
        <div class="card mb-4">
            {% if market.display_image %}
            <img src="{{ market.display_image.url }}" class="card-img-top" alt="{{ market.title }}" style="max-height: 300px; object-fit: cover;">
            {% endif %}
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h3 mb-2">{{ market.title }}</h1>
                        <p class="text-muted mb-0">{{ event.title }}</p>
                    </div>
                    <span class="badge bg-{% if market.is_trading_active %}success{% else %}secondary{% endif %} fs-6">
                        {% if market.is_trading_active %}Trading Active{% else %}{{ market.get_status_display }}{% endif %}
                    </span>
                </div>

                {% if market.description %}
                <p class="mt-3">{{ market.description }}</p>
                {% endif %}

                <!-- Current Prices (AMM-powered) -->
                <div class="row text-center mt-4">
                    <div class="col-6">
                        <div class="p-3 bg-success bg-opacity-10 rounded" id="yes-card">
                            <small class="text-muted d-block">YES</small>
                            <span class="price-display yes-color fs-3" id="yes-price">{{ amm_prices.yes_price }}c</span>
                            <small class="text-muted d-block"><span id="yes-implied">{{ amm_prices.yes_price }}</span>% chance</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 bg-danger bg-opacity-10 rounded" id="no-card">
                            <small class="text-muted d-block">NO</small>
                            <span class="price-display no-color fs-3" id="no-price">{{ amm_prices.no_price }}c</span>
                            <small class="text-muted d-block"><span id="no-implied">{{ amm_prices.no_price }}</span>% chance</small>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted"><i class="bi bi-lightning-charge"></i> AMM-powered instant trading</small>
                </div>

                <div class="row mt-3 text-center text-muted small">
                    <div class="col-4">
                        <i class="bi bi-bar-chart"></i> {{ market.total_volume }} traded
                    </div>
                    <div class="col-4">
                        <i class="bi bi-clock"></i> Ends {{ event.trading_ends|date:"M d, Y" }}
                    </div>
                    <div class="col-4">
                        {% if market.spread %}
                        <i class="bi bi-arrows-expand"></i> {{ market.spread }}c spread
                        {% endif %}
                    </div>
                </div>

                <!-- Price Chart -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Price History</h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" data-timeframe="1h">1H</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="24h">24H</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="7d">7D</button>
                            <button type="button" class="btn btn-outline-secondary" data-timeframe="all">All</button>
                        </div>
                    </div>
                    <div style="height: 200px; position: relative;">
                        <canvas id="priceChart"></canvas>
                        <div id="chartLoading" class="position-absolute top-50 start-50 translate-middle text-muted">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading chart...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Interface -->
        {% if market.is_trading_active %}
        <div class="card mb-4">
            <div class="card-header p-0">
                <!-- Trading Mode Tabs -->
                <ul class="nav nav-tabs card-header-tabs" id="tradingTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="quick-bet-tab" data-bs-toggle="tab"
                                data-bs-target="#quick-bet" type="button" role="tab">
                            <i class="bi bi-lightning-charge"></i> Quick Bet
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="limit-order-tab" data-bs-toggle="tab"
                                data-bs-target="#limit-order" type="button" role="tab">
                            <i class="bi bi-sliders"></i> Limit Order
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                <div class="tab-content" id="tradingTabContent">
                    <!-- Quick Bet Tab (Market Order) -->
                    <div class="tab-pane fade show active" id="quick-bet" role="tabpanel">
                        <form method="post" action="{% url 'predictions:place_order' market.pk %}" id="quick-bet-form">
                            {% csrf_token %}
                            <!-- Market Order implies price is None/Empty -->
                            <input type="hidden" name="price" value="">

                            <!-- Buy/Sell Toggle -->
                            <div class="mb-3">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="order_type" id="quick_buy" value="BUY" checked>
                                    <label class="btn btn-outline-success" for="quick_buy">
                                        <i class="bi bi-cart-plus"></i> Buy
                                    </label>

                                    <input type="radio" class="btn-check" name="order_type" id="quick_sell" value="SELL">
                                    <label class="btn btn-outline-danger" for="quick_sell">
                                        <i class="bi bi-cart-dash"></i> Sell
                                    </label>
                                </div>
                            </div>

                            <!-- Contract Type -->
                            <div class="mb-4">
                                <label class="form-label">Contract</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="outcome" id="quick_type_yes" value="YES" checked>
                                    <label class="btn btn-outline-success btn-lg" for="quick_type_yes">
                                        <i class="bi bi-check-circle"></i> YES
                                    </label>

                                    <input type="radio" class="btn-check" name="outcome" id="quick_type_no" value="NO">
                                    <label class="btn btn-outline-danger btn-lg" for="quick_type_no">
                                        <i class="bi bi-x-circle"></i> NO
                                    </label>
                                </div>
                            </div>

                            <!-- Quantity Input -->
                            <div class="mb-3">
                                <label class="form-label">Quantity (Shares)</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" class="form-control" name="quantity" id="quick_quantity"
                                           min="1" step="1" value="10" required>
                                    <span class="input-group-text">shares</span>
                                </div>
                                <small class="text-muted">
                                    Est. Cost: <span id="quick-est-cost">-</span>
                                </small>
                            </div>

                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="bi bi-lightning-charge"></i> Place Market Order
                            </button>
                        </form>
                    </div>

                    <!-- Limit Order Tab -->
                    <div class="tab-pane fade" id="limit-order" role="tabpanel">
                        <form method="post" action="{% url 'predictions:place_order' market.pk %}" id="order-form">
                            {% csrf_token %}

                            <!-- Order Side -->
                            <div class="mb-3">
                                <label class="form-label">Action</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="order_type" id="side_buy" value="BUY" checked>
                                    <label class="btn btn-outline-success" for="side_buy">Buy</label>

                                    <input type="radio" class="btn-check" name="order_type" id="side_sell" value="SELL">
                                    <label class="btn btn-outline-danger" for="side_sell">Sell</label>
                                </div>
                            </div>

                            <!-- Contract Type -->
                            <div class="mb-3">
                                <label class="form-label">Contract</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="outcome" id="type_yes" value="YES" checked>
                                    <label class="btn btn-outline-success" for="type_yes">YES</label>

                                    <input type="radio" class="btn-check" name="outcome" id="type_no" value="NO">
                                    <label class="btn btn-outline-danger" for="type_no">NO</label>
                                </div>
                            </div>

                            <!-- Price -->
                            <div class="mb-3">
                                <label class="form-label">Price (1-99c)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="price" id="price_input"
                                           min="0.01" max="0.99" step="0.01" value="0.50" required>
                                    <span class="input-group-text">$</span>
                                </div>
                                <small class="text-muted">Price per share (e.g. 0.50)</small>
                            </div>

                            <!-- Quantity -->
                            <div class="mb-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity" id="quantity_input"
                                       min="1" value="10" required>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-check-circle"></i> Place Limit Order
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p class="mb-3">You need to be logged in to trade.</p>
                    <a href="{% url 'login' %}" class="btn btn-primary">Login to Trade</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Orderbook -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-book"></i> Orderbook</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- YES Orderbook -->
                    <div class="col-6">
                        <h6 class="text-center yes-color">YES</h6>
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr class="small text-muted">
                                    <th>Bid</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="yes-bids-body">
                                {% for level in orderbook.yes_bids %}
                                <tr class="orderbook-row bg-success bg-opacity-10">
                                    <td class="yes-color">{{ level.price }}c</td>
                                    <td class="text-end">{{ level.quantity }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No bids</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <hr>
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr class="small text-muted">
                                    <th>Ask</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="yes-asks-body">
                                {% for level in orderbook.yes_asks %}
                                <tr class="orderbook-row">
                                    <td>{{ level.price }}c</td>
                                    <td class="text-end">{{ level.quantity }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No asks</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- NO Orderbook -->
                    <div class="col-6">
                        <h6 class="text-center no-color">NO</h6>
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr class="small text-muted">
                                    <th>Bid</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="no-bids-body">
                                {% for level in orderbook.no_bids %}
                                <tr class="orderbook-row bg-danger bg-opacity-10">
                                    <td class="no-color">{{ level.price }}c</td>
                                    <td class="text-end">{{ level.quantity }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No bids</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <hr>
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr class="small text-muted">
                                    <th>Ask</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="no-asks-body">
                                {% for level in orderbook.no_asks %}
                                <tr class="orderbook-row">
                                    <td>{{ level.price }}c</td>
                                    <td class="text-end">{{ level.quantity }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-muted text-center">No asks</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades (AMM) -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Trades</h5>
                <small class="text-muted"><i class="bi bi-lightning-charge"></i> AMM</small>
            </div>
            <div class="card-body p-0">
                {% if amm_trades %}
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr class="small text-muted">
                            <th class="ps-3">Time</th>
                            <th>Action</th>
                            <th>Type</th>
                            <th>Avg Price</th>
                            <th class="text-end pe-3">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="trades-tbody">
                        {% for trade in amm_trades %}
                        <tr class="orderbook-row">
                            <td class="ps-3">{{ trade.executed_at|date:"H:i:s" }}</td>
                            <td>
                                <span class="badge {% if trade.side == 'buy' %}bg-success{% else %}bg-warning text-dark{% endif %}">
                                    {{ trade.side|upper }}
                                </span>
                            </td>
                            <td>
                                <span class="{% if trade.contract_type == 'yes' %}yes-color{% else %}no-color{% endif %} fw-bold">
                                    {{ trade.contract_type|upper }}
                                </span>
                            </td>
                            <td>
                                {{ trade.avg_price|floatformat:1 }}c
                                {% if trade.price_before != trade.price_after %}
                                <small class="text-muted">
                                    {% if trade.price_after > trade.price_before %}
                                    <i class="bi bi-arrow-up text-success"></i>
                                    {% else %}
                                    <i class="bi bi-arrow-down text-danger"></i>
                                    {% endif %}
                                </small>
                                {% endif %}
                            </td>
                            <td class="text-end pe-3">{{ trade.quantity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted text-center py-3 mb-0">No trades yet</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- User Position -->
        {% if user.is_authenticated and user_position and user_position.has_position %}
        <div class="card mb-4 position-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-briefcase"></i> Your Position</h5>
            </div>
            <div class="card-body">
                {% if user_position.yes_quantity > 0 %}
                <div class="d-flex justify-content-between mb-2">
                    <span class="yes-color"><strong>YES</strong></span>
                    <span>{{ user_position.yes_quantity }} contracts @ {{ user_position.yes_avg_cost|floatformat:1 }}c avg</span>
                </div>
                {% endif %}
                {% if user_position.no_quantity > 0 %}
                <div class="d-flex justify-content-between mb-2">
                    <span class="no-color"><strong>NO</strong></span>
                    <span>{{ user_position.no_quantity }} contracts @ {{ user_position.no_avg_cost|floatformat:1 }}c avg</span>
                </div>
                {% endif %}
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Unrealized P&L</span>
                    <span class="{% if user_position.total_unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if user_position.total_unrealized_pnl >= 0 %}+{% endif %}${{ user_position.total_unrealized_pnl|floatformat:2 }}
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- User's Open Orders -->
        {% if user.is_authenticated and user_orders %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> Your Orders</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for order in user_orders %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge {% if order.side == 'buy' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ order.side|upper }}
                        </span>
                        <span class="badge {% if order.contract_type == 'yes' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ order.contract_type|upper }}
                        </span>
                        <span class="ms-2">{{ order.remaining_quantity }} @ {{ order.price }}c</span>
                    </div>
                    <form method="post" action="{% url 'predictions:cancel_order' order.pk %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Cancel this order?')">
                            <i class="bi bi-x"></i>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Market Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Market Stats</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted">Best YES Bid</td>
                        <td class="text-end">{{ market.best_yes_bid|default:"-" }}c</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Best YES Ask</td>
                        <td class="text-end">{{ market.best_yes_ask|default:"-" }}c</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Best NO Bid</td>
                        <td class="text-end">{{ market.best_no_bid|default:"-" }}c</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Best NO Ask</td>
                        <td class="text-end">{{ market.best_no_ask|default:"-" }}c</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Total Volume</td>
                        <td class="text-end">{{ market.total_volume }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Shares Outstanding</td>
                        <td class="text-end">{{ market.total_shares_outstanding }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Event Info -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Event Info</h5>
            </div>
            <div class="card-body">
                <h6><a href="{% url 'predictions:event_detail' event.slug %}">{{ event.title }}</a></h6>
                <p class="small text-muted">{{ event.description|truncatewords:30 }}</p>
                <hr>
                <small class="text-muted d-block">
                    <strong>Resolution Source:</strong> {{ event.resolution_source }}
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* WebSocket price update animations */
    @keyframes priceFlashUp {
        0% { background-color: rgba(25, 135, 84, 0.4); transform: scale(1.02); }
        100% { background-color: transparent; transform: scale(1); }
    }
    @keyframes priceFlashDown {
        0% { background-color: rgba(220, 53, 69, 0.4); transform: scale(1.02); }
        100% { background-color: transparent; transform: scale(1); }
    }
    .price-up {
        animation: priceFlashUp 0.5s ease-out;
    }
    .price-down {
        animation: priceFlashDown 0.5s ease-out;
    }
    .price-display {
        transition: all 0.3s ease;
    }
    /* Connection status indicator */
    .ws-status {
        position: fixed;
        bottom: 10px;
        right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0.8;
    }
    .ws-status.connected { background-color: #198754; color: white; }
    .ws-status.disconnected { background-color: #dc3545; color: white; }
    .ws-status.connecting { background-color: #ffc107; color: black; }
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for price history -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
(function() {
    'use strict';

    // Market ID for WebSocket connection
    const marketId = {{ market.pk }};

    // AMM price data from Django (will be updated by WebSocket)
    const marketPrices = {
        yesPrice: {{ amm_prices.yes_price|default:50 }},
        noPrice: {{ amm_prices.no_price|default:50 }},
        // Keep orderbook data for limit orders
        yesAsk: {{ market.best_yes_ask|default:"null" }},
        noAsk: {{ market.best_no_ask|default:"null" }},
        yesBid: {{ market.best_yes_bid|default:"null" }},
        noBid: {{ market.best_no_bid|default:"null" }}
    };

    // WebSocket connection
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const reconnectDelay = 2000;

    // Create connection status indicator
    function createStatusIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'ws-status';
        indicator.className = 'ws-status connecting';
        indicator.textContent = 'Connecting...';
        document.body.appendChild(indicator);
        return indicator;
    }

    // Update status indicator
    function updateStatus(status, text) {
        const indicator = document.getElementById('ws-status');
        if (indicator) {
            indicator.className = 'ws-status ' + status;
            indicator.textContent = text;
            // Auto-hide when connected after 3 seconds
            if (status === 'connected') {
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 500);
                }, 3000);
            }
        }
    }

    // Connect to WebSocket
    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = wsScheme + '://' + window.location.host + '/ws/market/' + marketId + '/';

        console.log('Connecting to WebSocket:', wsUrl);
        socket = new WebSocket(wsUrl);

        socket.onopen = function(e) {
            console.log('WebSocket connected');
            reconnectAttempts = 0;
            updateStatus('connected', 'Live');
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log('WebSocket message:', data);
            handleMessage(data);
        };

        socket.onclose = function(e) {
            console.log('WebSocket closed:', e.code, e.reason);
            if (reconnectAttempts < maxReconnectAttempts) {
                updateStatus('disconnected', 'Reconnecting...');
                reconnectAttempts++;
                setTimeout(connectWebSocket, reconnectDelay * reconnectAttempts);
            } else {
                updateStatus('disconnected', 'Disconnected');
            }
        };

        socket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }

    // Handle incoming WebSocket messages
    function handleMessage(message) {
        const type = message.type;
        const data = message.data || message;  // Handle both nested and flat formats

        switch (type) {
            case 'initial_state':
                // Initial state on connect (AMM prices)
                updatePrices(data.last_yes_price, data.last_no_price, false);
                marketPrices.yesPrice = data.last_yes_price || 50;
                marketPrices.noPrice = data.last_no_price || 50;
                marketPrices.yesAsk = data.best_yes_ask || null;
                marketPrices.noAsk = data.best_no_ask || null;
                marketPrices.yesBid = data.best_yes_bid || null;
                marketPrices.noBid = data.best_no_bid || null;
                updateQuickBetEstimate();
                console.log('Initial market state received:', data);
                break;

            case 'market_update':
                // Live AMM price updates
                updatePrices(data.last_yes_price, data.last_no_price, true);
                marketPrices.yesPrice = data.last_yes_price || marketPrices.yesPrice;
                marketPrices.noPrice = data.last_no_price || marketPrices.noPrice;
                marketPrices.yesAsk = data.best_yes_ask || null;
                marketPrices.noAsk = data.best_no_ask || null;
                marketPrices.yesBid = data.best_yes_bid || null;
                marketPrices.noBid = data.best_no_bid || null;
                updateQuickBetEstimate();
                console.log('Market update:', data);
                break;

            case 'trade_executed':
                // New trade - add to recent trades table
                addTradeToTable(data);
                console.log('Trade executed:', data);
                break;

            case 'orderbook_update':
                // Orderbook changed - could refresh orderbook here
                console.log('Orderbook updated:', data);
                break;

            case 'pong':
                // Heartbeat response
                break;
        }
    }

    // Update price displays with animation
    function updatePrices(newYesPrice, newNoPrice, animate) {
        const yesPrice = document.getElementById('yes-price');
        const noPrice = document.getElementById('no-price');
        const yesImplied = document.getElementById('yes-implied');
        const noImplied = document.getElementById('no-implied');
        const yesCard = document.getElementById('yes-card');
        const noCard = document.getElementById('no-card');

        // Update YES price
        if (yesPrice && newYesPrice !== undefined) {
            const oldYes = marketPrices.lastYes;
            if (newYesPrice !== oldYes) {
                yesPrice.textContent = newYesPrice + 'c';
                if (yesImplied) yesImplied.textContent = newYesPrice;
                marketPrices.lastYes = newYesPrice;

                if (animate && yesCard) {
                    yesCard.classList.remove('price-up', 'price-down');
                    void yesCard.offsetWidth; // Trigger reflow
                    yesCard.classList.add(newYesPrice > oldYes ? 'price-up' : 'price-down');
                }
            }
        }

        // Update NO price
        if (noPrice && newNoPrice !== undefined) {
            const oldNo = marketPrices.lastNo;
            if (newNoPrice !== oldNo) {
                noPrice.textContent = newNoPrice + 'c';
                if (noImplied) noImplied.textContent = newNoPrice;
                marketPrices.lastNo = newNoPrice;

                if (animate && noCard) {
                    noCard.classList.remove('price-up', 'price-down');
                    void noCard.offsetWidth; // Trigger reflow
                    noCard.classList.add(newNoPrice > oldNo ? 'price-up' : 'price-down');
                }
            }
        }
    }

    // Add new AMM trade to the trades table
    function addTradeToTable(trade) {
        const tbody = document.getElementById('trades-tbody');
        if (!tbody) return;

        const row = document.createElement('tr');
        row.className = 'orderbook-row';
        row.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';

        const time = new Date(trade.executed_at);
        const timeStr = time.toLocaleTimeString('en-US', { hour12: false });

        // Action badge (BUY = green, SELL = yellow)
        const side = trade.side || 'buy';
        const actionBadgeClass = side === 'buy' ? 'bg-success' : 'bg-warning text-dark';

        // Contract type color
        const typeColorClass = trade.contract_type === 'yes' ? 'yes-color' : 'no-color';

        // Price movement arrow
        const priceBefore = trade.price_before || trade.price;
        const priceAfter = trade.price_after || trade.price;
        const avgPrice = trade.avg_price || trade.price;
        let arrow = '';
        if (priceAfter > priceBefore) {
            arrow = '<i class="bi bi-arrow-up text-success"></i>';
        } else if (priceAfter < priceBefore) {
            arrow = '<i class="bi bi-arrow-down text-danger"></i>';
        }

        row.innerHTML = `
            <td class="ps-3">${timeStr}</td>
            <td><span class="badge ${actionBadgeClass}">${side.toUpperCase()}</span></td>
            <td><span class="${typeColorClass} fw-bold">${trade.contract_type.toUpperCase()}</span></td>
            <td>${avgPrice}c <small class="text-muted">${arrow}</small></td>
            <td class="text-end pe-3">${trade.quantity}</td>
        `;

        // Insert at top of table
        tbody.insertBefore(row, tbody.firstChild);

        // Fade out highlight
        setTimeout(() => {
            row.style.transition = 'background-color 1s ease';
            row.style.backgroundColor = 'transparent';
        }, 100);

        // Keep only last 20 trades
        while (tbody.children.length > 20) {
            tbody.removeChild(tbody.lastChild);
        }
    }

    // Send ping to keep connection alive
    function sendPing() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: 'ping' }));
        }
    }

    // Get AMM market price for a contract type
    // AMM always has liquidity - price comes directly from the LMSR formula
    function getMarketPrice(contractType) {
        if (contractType === 'yes') {
            return marketPrices.yesPrice || 50;
        } else {
            return marketPrices.noPrice || 50;
        }
    }

    // Check if we're in buy or sell mode
    function isSellMode() {
        const sellRadio = document.getElementById('quick_sell');
        return sellRadio && sellRadio.checked;
    }

    // Update UI for buy/sell mode toggle
    function updateBuySellMode() {
        const isSell = isSellMode();
        const actionInput = document.getElementById('quick_action');
        const amountLabel = document.getElementById('amount-label');
        const amountPrefix = document.getElementById('amount-prefix');
        const sharesSuffix = document.getElementById('shares-suffix');
        const amountInput = document.getElementById('quick_amount');
        const balanceInfo = document.getElementById('balance-info');
        const positionInfo = document.getElementById('position-info');
        const contractLabel = document.getElementById('contract-label');
        const sharesLabel = document.getElementById('estimate-shares-label');
        const resultLabel = document.getElementById('estimate-result-label');

        if (isSell) {
            // Sell mode: input is number of shares
            actionInput.value = 'sell';
            amountLabel.textContent = 'Shares to sell';
            amountPrefix.classList.add('d-none');
            sharesSuffix.classList.remove('d-none');
            amountInput.step = '1';
            amountInput.min = '1';
            amountInput.value = '10';
            balanceInfo.classList.add('d-none');
            positionInfo.classList.remove('d-none');
            contractLabel.textContent = 'Sell';
            sharesLabel.textContent = 'Selling:';
            resultLabel.textContent = 'You receive:';
        } else {
            // Buy mode: input is dollar amount
            actionInput.value = 'buy';
            amountLabel.textContent = 'Amount to bet';
            amountPrefix.classList.remove('d-none');
            sharesSuffix.classList.add('d-none');
            amountInput.step = '0.01';
            amountInput.min = '0.01';
            amountInput.value = '5.00';
            balanceInfo.classList.remove('d-none');
            positionInfo.classList.add('d-none');
            contractLabel.textContent = 'Bet on';
            sharesLabel.textContent = 'Shares:';
            resultLabel.textContent = 'Payout if correct:';
        }

        updateQuickBetEstimate();
    }

    // Update Quick Bet estimates
    function updateQuickBetEstimate() {
        const amountInput = document.getElementById('quick_amount');
        const yesRadio = document.getElementById('quick_type_yes');
        const sharesDisplay = document.getElementById('estimate-shares');
        const priceDisplay = document.getElementById('estimate-price');
        const payoutDisplay = document.getElementById('estimate-payout');
        const betButton = document.getElementById('quick-bet-button');

        if (!amountInput) return;

        const isSell = isSellMode();
        const contractType = yesRadio.checked ? 'yes' : 'no';
        const price = getMarketPrice(contractType);
        const contractLabel = contractType.toUpperCase();

        if (isSell) {
            // Sell mode: user enters number of shares
            const shares = parseInt(amountInput.value) || 0;
            const payout = (shares * price / 100).toFixed(2);

            sharesDisplay.innerHTML = '<strong>' + shares + '</strong> shares';
            priceDisplay.innerHTML = '<strong>' + price + '</strong>c each';
            payoutDisplay.innerHTML = '<strong class="text-success">$' + payout + '</strong>';

            // Update button
            betButton.innerHTML = '<i class="bi bi-cash-stack"></i> Sell ' + shares + ' ' + contractLabel + ' for ~$' + payout;
            betButton.className = 'btn btn-danger btn-lg w-100';
        } else {
            // Buy mode: user enters dollar amount
            const amount = parseFloat(amountInput.value) || 0;
            const shares = Math.floor(amount * 100 / price);
            const payout = shares; // Each share pays $1 if correct

            sharesDisplay.innerHTML = '~<strong>' + shares + '</strong> shares';
            priceDisplay.innerHTML = '<strong>' + price + '</strong>c each';
            payoutDisplay.innerHTML = '<strong>$' + payout.toFixed(2) + '</strong>';

            // Update button
            const buttonClass = contractType === 'yes' ? 'btn-success' : 'btn-danger';
            betButton.innerHTML = '<i class="bi bi-lightning-charge"></i> Buy ' + contractLabel + ' for $' + amount.toFixed(2);
            betButton.className = 'btn ' + buttonClass + ' btn-lg w-100';
        }
    }

    // Calculate order cost dynamically (Limit Order tab)
    function updateCost() {
        const priceInput = document.getElementById('price_input');
        const quantityInput = document.getElementById('quantity_input');
        const costDisplay = document.getElementById('order_cost');

        if (priceInput && quantityInput && costDisplay) {
            const price = parseInt(priceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;
            const cost = (price * quantity / 100).toFixed(2);
            costDisplay.innerHTML = 'Max Cost: <strong>$' + cost + '</strong>';
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Create WebSocket status indicator and connect
        createStatusIndicator();
        connectWebSocket();

        // Send ping every 30 seconds to keep connection alive
        setInterval(sendPing, 30000);

        // Limit Order tab listeners
        const priceInput = document.getElementById('price_input');
        const quantityInput = document.getElementById('quantity_input');

        if (priceInput) priceInput.addEventListener('input', updateCost);
        if (quantityInput) quantityInput.addEventListener('input', updateCost);
        updateCost();

        // Quick Bet tab listeners
        const quickAmount = document.getElementById('quick_amount');
        const quickYes = document.getElementById('quick_type_yes');
        const quickNo = document.getElementById('quick_type_no');
        const quickBuy = document.getElementById('quick_buy');
        const quickSell = document.getElementById('quick_sell');

        if (quickAmount) {
            quickAmount.addEventListener('input', updateQuickBetEstimate);
        }
        if (quickYes) {
            quickYes.addEventListener('change', updateQuickBetEstimate);
        }
        if (quickNo) {
            quickNo.addEventListener('change', updateQuickBetEstimate);
        }
        // Buy/Sell toggle listeners
        if (quickBuy) {
            quickBuy.addEventListener('change', updateBuySellMode);
        }
        if (quickSell) {
            quickSell.addEventListener('change', updateBuySellMode);
        }

        // Initialize Quick Bet estimate
        updateQuickBetEstimate();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (socket) {
            socket.close();
        }
    });

    // ====== PRICE CHART ======
    let priceChart = null;
    let currentTimeframe = '1h';

    // Initialize price chart
    function initPriceChart() {
        const ctx = document.getElementById('priceChart');
        if (!ctx) return;

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'YES Price',
                        data: [],
                        borderColor: 'rgb(25, 135, 84)',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    },
                    {
                        label: 'NO Price',
                        data: [],
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 8,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + 'c';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm',
                                day: 'MMM d'
                            }
                        },
                        grid: { display: false },
                        ticks: { font: { size: 10 } }
                    },
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + 'c';
                            },
                            font: { size: 10 }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });

        // Load initial data
        loadPriceHistory(currentTimeframe);

        // Set up timeframe buttons
        document.querySelectorAll('[data-timeframe]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-timeframe]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTimeframe = this.dataset.timeframe;
                loadPriceHistory(currentTimeframe);
            });
        });
    }

    // Load price history from API
    function loadPriceHistory(timeframe) {
        const loading = document.getElementById('chartLoading');
        if (loading) loading.style.display = 'block';

        fetch('/api/markets/' + marketId + '/price-history/?timeframe=' + timeframe)
            .then(response => response.json())
            .then(data => {
                if (loading) loading.style.display = 'none';

                if (data.price_history && data.price_history.length > 0) {
                    // Format data for Chart.js
                    const yesData = data.price_history.map(p => ({
                        x: new Date(p.time),
                        y: p.yes_price
                    }));
                    const noData = data.price_history.map(p => ({
                        x: new Date(p.time),
                        y: p.no_price
                    }));

                    priceChart.data.datasets[0].data = yesData;
                    priceChart.data.datasets[1].data = noData;
                    priceChart.update('none');
                } else {
                    // No data - show current price as single point
                    const now = new Date();
                    priceChart.data.datasets[0].data = [{ x: now, y: marketPrices.yesPrice || 50 }];
                    priceChart.data.datasets[1].data = [{ x: now, y: marketPrices.noPrice || 50 }];
                    priceChart.update('none');
                }
            })
            .catch(err => {
                console.error('Failed to load price history:', err);
                if (loading) loading.style.display = 'none';
            });
    }

    // Add new price point to chart (called on WebSocket updates)
    function addPriceToChart(yesPrice, noPrice) {
        if (!priceChart) return;

        const now = new Date();
        priceChart.data.datasets[0].data.push({ x: now, y: yesPrice });
        priceChart.data.datasets[1].data.push({ x: now, y: noPrice });

        // Keep only last 100 points for performance
        if (priceChart.data.datasets[0].data.length > 100) {
            priceChart.data.datasets[0].data.shift();
            priceChart.data.datasets[1].data.shift();
        }

        priceChart.update('none');
    }

    // ====== ORDER BOOK & POSITION POLLING ======
    function fetchOrderBook() {
        fetch('/predictions/api/markets/' + marketId + '/orderbook/')
            .then(response => response.json())
            .then(data => {
                if (data.orderbook) {
                    renderOrderBook(data.orderbook);
                }
            })
            .catch(err => console.error('Error fetching orderbook:', err));
    }

    function renderOrderBook(book) {
        renderTableRows('yes-bids-body', book.yes_bids, 'yes-color', 'bg-success bg-opacity-10');
        renderTableRows('yes-asks-body', book.yes_asks, '', '');
        renderTableRows('no-bids-body', book.no_bids, 'no-color', 'bg-danger bg-opacity-10');
        renderTableRows('no-asks-body', book.no_asks, '', '');
    }

    function renderTableRows(elementId, rows, colorClass, rowClass) {
        const tbody = document.getElementById(elementId);
        if (!tbody) return;
        
        if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No orders</td></tr>';
            return;
        }

        let html = '';
        rows.forEach(row => {
            html += `<tr class="orderbook-row ${rowClass}">
                        <td class="${colorClass}">${row.price}c</td>
                        <td class="text-end">${row.quantity}</td>
                     </tr>`;
        });
        tbody.innerHTML = html;
    }

    function fetchUserPosition() {
        fetch('/predictions/api/markets/' + marketId + '/position/')
            .then(response => response.json())
            .then(data => {
                updatePositionCard(data);
                // Also update hidden inputs in Quick Bet
                const yesPosSpan = document.getElementById('yes-position');
                const noPosSpan = document.getElementById('no-position');
                if (yesPosSpan) yesPosSpan.textContent = data.yes_quantity;
                if (noPosSpan) noPosSpan.textContent = data.no_quantity;
            })
            .catch(err => console.error('Error fetching position:', err));
    }

    function updatePositionCard(data) {
        // This is a simplified update. Ideally, we rebuild the card or specific elements.
        // For now, let's just rely on page refresh for full card updates, 
        // OR implements robust DOM updating if we really want "real-time" positions.
        // Given complexity, let's stick to polling orderbook primarily.
    }

    // Poll every 2 seconds
    setInterval(fetchOrderBook, 2000);
    setInterval(fetchUserPosition, 5000);

    // Initialize chart on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure Chart.js is loaded
        setTimeout(initPriceChart, 100);
    });
})();
</script>
{% endblock %}
